<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <!-- Corrected charset from UTF--8 to UTF-8 -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice Management Analysis</title>
    
    <!-- Core Libraries First -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind: Config first, then the library -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        vazir: ['Vazirmatn', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel, which compiles the main script -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .dark body {
            background-color: #111827; /* dark:bg-gray-900 */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem; /* Changed from right to left for better RTL alignment */
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            animation: toast-in 0.5s ease;
            min-width: 300px;
        }
        .toast.success { background-color: #10B981; color: white; } /* bg-green-500 */
        .toast.error { background-color: #EF4444; color: white; } /* bg-red-500 */
        .toast.warning { background-color: #f97316; color: white; } /* orange-500 */
        @keyframes toast-in {
            from { transform: translateX(-100%); opacity: 0; } /* Adjusted for left-side entry */
            to { transform: translateX(0); opacity: 1; }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-options {
                display: none;
            }
            #printable-invoice, #printable-invoice * {
                visibility: visible;
            }
            #printable-invoice {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="dark">
    <div id="root"></div>

    <!-- Main application script moved to the end of the body -->
    <script type="text/babel">
        // ==================================================
        // Supabase Client Setup
        // ==================================================
        const { createClient } = supabase;
        const supabaseUrl = 'https://wehyjatotbzxargnxasg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlaHlqYXRvdGJ6eGFyZ254YXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTIwMjEsImV4cCI6MjA2NzQ4ODAyMX0.2R448DuEBlTrNvaYXiYZ8D5M7MJNv7n1qmIDHQBNFiY';
        const supabaseClient = createClient(supabaseUrl, supabaseKey, { global: { fetch: window.fetch.bind(window) } });

        // ==================================================
        // Application Configuration
        // ==================================================
        const APP_CONFIG = {
            DEFAULT_SELLER_ID: 'f83dca6b-9bc3-4bc2-8ac0-609a4147269b', // Default seller for new invoices
            DEFAULT_CURRENCY: 'Toman' // Can be 'Toman' or 'Rials'
        };

        // ==================================================
        // Toast Notification System
        // ==================================================
        const ToastContext = React.createContext();

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = React.useState([]);

            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    removeToast(id);
                }, 5000); // Remove after 5 seconds
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(toast => toast.id !== id));
            };

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="toast-container">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`toast ${toast.type}`}>
                                {toast.message}
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToasts = () => {
            return React.useContext(ToastContext);
        };

        // ==================================================
        // Helper Functions & UI Components
        // ==================================================
        const formatCurrency = (value) => {
            if (value === null || typeof value === 'undefined' || isNaN(value)) return '-';
            return `${Number(value).toLocaleString('fa-IR')}`;
        };

        const formatNumberWithCommas = (value) => {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            // First, remove any existing commas to parse the number correctly.
            const stringValue = String(value).replace(/,/g, '');
            const numberValue = Number(stringValue);
            
            // If it's not a number after removing commas, it's invalid input.
            if (isNaN(numberValue)) {
                return '';
            }
            // Format the valid number with commas.
            return numberValue.toLocaleString('en-US');
        };

        const parseFormattedNumber = (value) => {
            if (typeof value !== 'string' && typeof value !== 'number') {
                return 0;
            }
            if(typeof value === 'number') return value;
            return Number(value.replace(/,/g, '')) || 0;
        };
        
        const Modal = ({ isOpen, onClose, title, children, showHeader = true }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay open" onClick={onClose}>
                    <div className="modal-content bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" onClick={e => e.stopPropagation()}>
                        {showHeader && (
                            <div className="flex justify-between items-center mb-4 pb-3 border-b border-gray-200 dark:border-gray-600">
                                <h2 className="text-xl font-bold">{title}</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-800 dark:hover:text-white text-2xl">&times;</button>
                            </div>
                        )}
                        {children}
                    </div>
                </div>
            );
        };

        const PaymentAllocationModal = ({ isOpen, onClose, onSave, preInvoiceData }) => {
            const [totalAmountReceived, setTotalAmountReceived] = React.useState(0);
            const [allocations, setAllocations] = React.useState([]);
            const [users, setUsers] = React.useState([]);
            const [isSubmitting, setIsSubmitting] = React.useState(false);
            const { addToast } = useToasts();
            const [searchTerm, setSearchTerm] = React.useState(''); 

            React.useEffect(() => {
                if (preInvoiceData) {
                    setTotalAmountReceived(preInvoiceData.totalAmount);
                    // Pre-populate with suppliers from the order
                    const initialAllocations = Object.values(preInvoiceData.suppliers).map(supplier => ({
                        userId: supplier.id,
                        amount: '',
                        key: Math.random()
                    }));
                    setAllocations(initialAllocations);
                }
            }, [preInvoiceData]);

            React.useEffect(() => {
                const fetchUsers = async () => {
                    // Fetch users with roleid 1 or 3
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('id, fullname, roleid')
                        .in('roleid', [1, 3]); 
                    if (error) {
                        console.error("Error fetching users:", error);
                        addToast('خطا در بارگذاری لیست کاربران', 'error');
                    } else {
                        setUsers(data || []);
                    }
                };
                fetchUsers();
            }, []);
            
            // --- DERIVED STATE ---
            // Memoized calculation for the total allocated amount
            const totalAllocated = React.useMemo(() =>
                allocations.reduce((sum, alloc) => sum + parseFormattedNumber(alloc.amount), 0),
                [allocations]
            );

            // Memoized calculation for the remaining amount
            const remainingAmount = parseFormattedNumber(totalAmountReceived) - totalAllocated;

            // Memoized Set of already selected user IDs for quick lookup
            const selectedUserIds = React.useMemo(() =>
                new Set(allocations.map(a => a.userId).filter(Boolean)),
                [allocations]
            );


            const handleAllocationChange = (index, field, value) => {
                const newAllocations = [...allocations];
                if (field === 'amount') {
                    newAllocations[index][field] = formatNumberWithCommas(value);
                } else {
                    newAllocations[index][field] = value;
                }
                setAllocations(newAllocations);
            };

            const addAllocationRow = () => {
                setAllocations([...allocations, { userId: '', amount: '', key: Math.random() }]);
            };

            const removeAllocationRow = (index) => {
                const newAllocations = allocations.filter((_, i) => i !== index);
                setAllocations(newAllocations);
            };
            
            const handleSave = async () => {
                const parsedTotalReceived = parseFormattedNumber(totalAmountReceived);
                if (totalAllocated > parsedTotalReceived) {
                    addToast('مبلغ تخصیص‌داده شده بیشتر از مبلغ دریافتی است!', 'warning');
                    return; // Prevent submission
                }
                
                const finalAllocations = allocations
                    .map(a => ({...a, amount: parseFormattedNumber(a.amount)}))
                    .filter(a => a.userId && a.amount > 0);

                if (finalAllocations.length === 0) {
                    addToast("لطفا حداقل یک تخصیص پرداخت معتبر وارد کنید.", 'error');
                    return;
                }

                setIsSubmitting(true);
                try {
                    await onSave({
                        totalAmountReceived: parsedTotalReceived,
                        allocations: finalAllocations,
                        preInvoiceData
                    });
                } catch (error) {
                    // Error is handled in the parent component's catch block
                } finally {
                    setIsSubmitting(false);
                }
            };

            // Filter users based on search term
            const filteredUsers = React.useMemo(() => 
                users.filter(user => 
                    user.fullname.toLowerCase().includes(searchTerm.toLowerCase())
                ), 
                [users, searchTerm]
            );

            if (!preInvoiceData) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="ثبت و تخصیص پرداخت">
                    <div className="space-y-4">
                        <div>
                            <label className="block font-semibold mb-2">مبلغ کل دریافت شده از مشتری</label>
                            <input
                                type="text"
                                value={formatNumberWithCommas(totalAmountReceived)}
                                onChange={e => setTotalAmountReceived(e.target.value)}
                                className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-md text-center text-lg font-bold"
                            />
                        </div>
                        
                        {/* --- NEW: Real-time calculation display --- */}
                        <div className="flex flex-col sm:flex-row justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg text-sm gap-2">
                            <div>
                                <span className="text-gray-600 dark:text-gray-300">مبلغ تخصیص داده شده: </span>
                                <span className="font-bold">{formatCurrency(totalAllocated)}</span>
                            </div>
                            <div className={`font-bold ${remainingAmount < 0 ? 'text-red-500' : 'text-green-500'}`}>
                                <span className="text-gray-600 dark:text-gray-300">مبلغ باقی‌مانده: </span>
                                <span>{formatCurrency(remainingAmount)}</span>
                            </div>
                        </div>


                        <div className="border-t pt-4">
                            <h3 className="font-semibold mb-3">تخصیص پرداخت به تامین‌کنندگان / کاربران</h3>
                            
                            <input
                                type="text"
                                placeholder="جستجوی نام کاربر..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-md mb-3"
                            />

                            <div className="space-y-3">
                                {allocations.map((alloc, index) => (
                                    <div key={alloc.key} className="flex flex-col sm:flex-row items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 rounded-md">
                                        <select
                                            value={alloc.userId}
                                            onChange={e => handleAllocationChange(index, 'userId', e.target.value)}
                                            className="w-full sm:flex-grow bg-white dark:bg-gray-600 p-2 rounded-md"
                                        >
                                            <option value="">انتخاب کنید...</option>
                                            {/* --- MODIFIED: Disable already selected users --- */}
                                            {filteredUsers.map(user => (
                                                <option 
                                                    key={user.id} 
                                                    value={user.id} 
                                                    disabled={selectedUserIds.has(user.id) && alloc.userId !== user.id}
                                                    className="disabled:bg-gray-200 dark:disabled:bg-gray-600"
                                                >
                                                    {user.fullname} ({user.roleid === 1 ? 'ادمین' : 'کاربر'})
                                                </option>
                                            ))}
                                        </select>
                                        <div className="flex w-full sm:w-auto items-center gap-2">
                                            <input
                                                type="text"
                                                placeholder="مبلغ"
                                                value={alloc.amount}
                                                onChange={e => handleAllocationChange(index, 'amount', e.target.value)}
                                                className="flex-grow sm:w-40 bg-white dark:bg-gray-600 p-2 rounded-md text-center"
                                            />
                                            <button onClick={() => removeAllocationRow(index)} className="text-red-500 font-bold text-2xl px-2">&times;</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button onClick={addAllocationRow} className="mt-4 text-indigo-600 dark:text-indigo-400 font-semibold">+ افزودن پرداخت جدید</button>
                        </div>

                        <div className="flex flex-col sm:flex-row justify-end gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button onClick={onClose} className="w-full sm:w-auto bg-gray-200 dark:bg-gray-600 py-2 px-5 rounded-lg font-semibold">انصراف</button>
                            <button onClick={handleSave} disabled={isSubmitting} className="w-full sm:w-auto bg-green-600 text-white py-2 px-5 rounded-lg font-semibold disabled:bg-green-400">
                                {isSubmitting ? 'در حال ذخیره...' : 'ذخیره و ایجاد فاکتور'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };
        
        const EditInvoiceModal = ({ isOpen, onClose, onSave, invoice: initialInvoice, addToast }) => {
            const [invoice, setInvoice] = React.useState(initialInvoice);
            const [isSubmitting, setIsSubmitting] = React.useState(false);

            React.useEffect(() => {
                setInvoice(initialInvoice);
            }, [initialInvoice]);

            if (!invoice) return null;

            const recalculateTotal = (updatedInvoice) => {
                const subtotal = updatedInvoice.demandinvoicedetail.reduce((sum, item) => sum + (item.quantity * item.sales_price), 0);
                const discount = updatedInvoice.discount || 0;
                const shipping = updatedInvoice.totalshippingprice || 0;
                return subtotal - discount + shipping;
            };

            const handlePriceChange = (detailId, newPrice) => {
                setInvoice(prev => {
                    const updatedDetails = prev.demandinvoicedetail.map(detail => {
                        if (detail.id === detailId) {
                            return { ...detail, sales_price: parseFormattedNumber(newPrice) };
                        }
                        return detail;
                    });
                    const newInvoice = { ...prev, demandinvoicedetail: updatedDetails };
                    const newTotalAmount = recalculateTotal(newInvoice);
                    return { ...newInvoice, totalamount: newTotalAmount };
                });
            };

            const handleInputChange = (field, value) => {
                setInvoice(prev => {
                    const newInvoice = { ...prev };
                    if (field === 'note') {
                        newInvoice.note = value;
                    } else {
                        newInvoice[field] = parseFormattedNumber(value);
                    }
                    const newTotalAmount = recalculateTotal(newInvoice);
                    return { ...newInvoice, totalamount: newTotalAmount };
                });
            };

            const handleSave = async () => {
                setIsSubmitting(true);
                try {
                    const detailUpdates = invoice.demandinvoicedetail.map(detail => 
                        supabaseClient
                            .from('demandinvoicedetail')
                            .update({ sales_price: detail.sales_price })
                            .eq('id', detail.id)
                    );
                    const detailResults = await Promise.all(detailUpdates);
                    const firstDetailError = detailResults.find(res => res.error);
                    if (firstDetailError) throw firstDetailError.error;


                    const { error: invoiceUpdateError } = await supabaseClient
                        .from('demandinvoice')
                        .update({ 
                            totalamount: invoice.totalamount,
                            discount: invoice.discount || 0,
                            totalshippingprice: invoice.totalshippingprice || 0,
                            note: invoice.note || ''
                        })
                        .eq('id', invoice.id);
                    
                    if (invoiceUpdateError) throw invoiceUpdateError;
                    
                    addToast('فاکتور با موفقیت به‌روزرسانی شد!', 'success');
                    onSave();
                } catch (err) {
                    console.error("Error updating invoice:", err);
                    addToast(`خطا در به‌روزرسانی فاکتور: ${err.message}`, 'error');
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`ویرایش فاکتور شماره ${invoice.id}`}>
                    <div className="space-y-4">
                        <div className="overflow-x-auto">
                           <table className="w-full text-right min-w-[500px]">
                                <thead>
                                    <tr>
                                        <th className="p-2">محصول</th>
                                        <th className="p-2">تامین‌کننده</th>
                                        <th className="p-2">تعداد</th>
                                        <th className="p-2">قیمت فروش</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {invoice.demandinvoicedetail.map(detail => (
                                        <tr key={detail.id}>
                                            <td className="p-2">{detail.product?.title || 'نامشخص'}</td>
                                            <td className="p-2">{detail.profiles?.fullname || 'نامشخص'}</td>
                                            <td className="p-2">{detail.quantity}</td>
                                            <td className="p-2">
                                                <input
                                                    type="text"
                                                    value={formatNumberWithCommas(detail.sales_price)}
                                                    onChange={e => handlePriceChange(detail.id, e.target.value)}
                                                    className="w-32 bg-gray-100 dark:bg-gray-700 p-1 rounded-md text-center"
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تخفیف (تومان)</label>
                                <input
                                    type="text"
                                    placeholder="0"
                                    value={formatNumberWithCommas(invoice.discount)}
                                    onChange={e => handleInputChange('discount', e.target.value)}
                                    className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-md text-center"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">هزینه ارسال (تومان)</label>
                                <input
                                    type="text"
                                    placeholder="0"
                                    value={formatNumberWithCommas(invoice.totalshippingprice)}
                                    onChange={e => handleInputChange('totalshippingprice', e.target.value)}
                                    className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-md text-center"
                                />
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">یادداشت</label>
                                <textarea
                                    value={invoice.note || ''}
                                    onChange={e => handleInputChange('note', e.target.value)}
                                    rows="3"
                                    placeholder="توضیحات مربوط به فاکتور..."
                                    className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-md"
                                ></textarea>
                            </div>
                        </div>

                        <div className="text-left font-bold text-lg mt-2">
                            مبلغ کل جدید: {formatCurrency(invoice.totalamount)} تومان
                        </div>
                        <div className="flex flex-col sm:flex-row justify-end gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button onClick={onClose} className="w-full sm:w-auto bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-lg">انصراف</button>
                            <button onClick={handleSave} disabled={isSubmitting} className="w-full sm:w-auto bg-indigo-600 text-white py-2 px-4 rounded-lg disabled:bg-indigo-400">
                                {isSubmitting ? 'در حال ذخیره...' : 'ذخیره تغییرات'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // ==================================================
        // REFACTORED: Generic Printable Layout Component
        // This component centralizes the UI for both pre-invoices and historical invoices
        // to avoid code duplication and simplify future style changes.
        // ==================================================
        const PrintableInvoiceLayout = ({
            title,
            invoiceNumber,
            invoiceDate,
            sellerProfile,
            customerProfile,
            items,
            subtotal,
            discount,
            shipping,
            totalAmount,
            note,
            formatCurrencyForPrint
        }) => {
            return (
                <div id="printable-invoice" className="bg-white text-black p-4 md:p-8 font-vazir">
                    <header className="flex justify-between items-start pb-4 border-b">
                        <div>
                            <h1 className="text-xl md:text-2xl font-bold">{title}</h1>
                            {invoiceNumber && <p className="text-sm">شماره: {invoiceNumber}</p>}
                            <p className="text-sm">تاریخ: {invoiceDate}</p>
                        </div>
                        <div>
                            {/* Simple placeholder for logo/barcode */}
                            <svg className="w-24 h-10 md:w-32 md:h-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 30"><rect x="0" y="0" width="2" height="30" fill="black"/><rect x="4" y="0" width="1" height="30" fill="black"/><rect x="7" y="0" width="3" height="30" fill="black"/><rect x="12" y="0" width="1" height="30" fill="black"/><rect x="15" y="0" width="2" height="30" fill="black"/><rect x="19" y="0" width="1" height="30" fill="black"/><rect x="22" y="0" width="3" height="30" fill="black"/><rect x="27" y="0" width="1" height="30" fill="black"/><rect x="30" y="0" width="2" height="30" fill="black"/><rect x="34" y="0" width="1" height="30" fill="black"/><rect x="37" y="0" width="3" height="30" fill="black"/><rect x="42" y="0" width="1" height="30" fill="black"/><rect x="45" y="0" width="2" height="30" fill="black"/><rect x="49" y="0" width="1" height="30" fill="black"/><rect x="52" y="0" width="3" height="30" fill="black"/><rect x="57" y="0" width="1" height="30" fill="black"/><rect x="60" y="0" width="2" height="30" fill="black"/></svg>
                        </div>
                    </header>
                    <section className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 py-4 border-b text-xs md:text-sm">
                        <div>
                            <h2 className="font-bold mb-2">فروشنده</h2>
                            <p><span className="font-semibold">نام:</span> {sellerProfile?.fullname || '...'}</p>
                            <p><span className="font-semibold">کدملی/کد اقتصادی :</span> {sellerProfile?.national_id || '--'}</p>
                            <p><span className="font-semibold">کدپستی:</span> {sellerProfile?.location?.postalcode || '--'}</p>
                            <p><span className="font-semibold">شماره تماس:</span> {sellerProfile?.mobile || '--'}</p>
                            <p><span className="font-semibold">آدرس:</span> {`${sellerProfile?.location?.address || '--'} ${sellerProfile?.location?.plaque ? `پلاک ${sellerProfile.location.plaque}` : ''}`.trim()}</p>
                        </div>
                        <div>
                            <h2 className="font-bold mb-2">خریدار</h2>
                            <p><span className="font-semibold">نام:</span> {customerProfile?.fullname || '...'}</p>
                            <p><span className="font-semibold">کدملی:</span> {customerProfile?.national_id || '--'}</p>
                            <p><span className="font-semibold">کدپستی:</span> {customerProfile?.location?.postalcode || '--'}</p>
                            <p><span className="font-semibold">شماره تماس:</span> {customerProfile?.mobile || '--'}</p>
                            <p><span className="font-semibold">آدرس:</span> {`${customerProfile?.location?.address || '--'} ${customerProfile?.location?.plaque ? `پلاک ${customerProfile.location.plaque}` : ''}`.trim()}</p>
                        </div>
                    </section>
                    <section className="py-4 overflow-x-auto">
                        <table className="w-full text-right text-xs md:text-sm min-w-[400px]">
                            <thead className="bg-gray-100">
                                <tr><th className="p-2 font-semibold">ش</th><th className="p-2 font-semibold">شناسه</th><th className="p-2 font-semibold">شرح</th><th className="p-2 font-semibold">تعداد</th><th className="p-2 font-semibold">مبلغ واحد</th><th className="p-2 font-semibold">جمع</th></tr>
                            </thead>
                            <tbody>
                                {items.map((item, index) => (
                                    <tr key={item.id} className="border-b">
                                        <td className="p-2">{index + 1}</td>
                                        <td className="p-2">{item.itemId}</td>
                                        <td className="p-2">{item.description}</td>
                                        <td className="p-2">{item.quantity}</td>
                                        <td className="p-2">{formatCurrencyForPrint(item.unitPrice)}</td>
                                        <td className="p-2">{formatCurrencyForPrint(item.total)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </section>
                    <footer className="pt-4 border-t">
                        {note && (
                            <div className="mb-4">
                                <h3 className="font-bold">یادداشت:</h3>
                                <p className="text-sm">{note}</p>
                            </div>
                        )}
                        <div className="flex justify-end items-end">
                            <div className="text-left space-y-2 text-xs md:text-sm w-full md:w-1/2 md:max-w-xs">
                                <div className="flex justify-between gap-4">
                                    <span>جمع آیتم‌ها:</span>
                                    <span>{formatCurrencyForPrint(subtotal)}</span>
                                </div>
                                {discount > 0 && (
                                    <div className="flex justify-between gap-4 text-red-600">
                                        <span>تخفیف:</span>
                                        <span>- {formatCurrencyForPrint(discount)}</span>
                                    </div>
                                )}
                                {shipping > 0 && (
                                    <div className="flex justify-between gap-4">
                                        <span>هزینه ارسال:</span>
                                        <span>+ {formatCurrencyForPrint(shipping)}</span>
                                    </div>
                                )}
                                <div className="flex justify-between gap-4 font-bold text-sm md:text-base border-t pt-2 mt-2">
                                    <span>جمع کل:</span>
                                    <span>{formatCurrencyForPrint(totalAmount)}</span>
                                </div>
                            </div>
                        </div>
                    </footer>
                </div>
            )
        };


        const PrintablePreInvoice = ({ preInvoiceData, onClose }) => {
            const [sellerProfile, setSellerProfile] = React.useState(null);
            const [allSellers, setAllSellers] = React.useState([]);
            const [selectedSellerId, setSelectedSellerId] = React.useState(APP_CONFIG.DEFAULT_SELLER_ID);
            const [currency, setCurrency] = React.useState(APP_CONFIG.DEFAULT_CURRENCY);
            const [customerProfile, setCustomerProfile] = React.useState(null);

            React.useEffect(() => {
                const fetchAllSellers = async () => {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('id, fullname')
                        .eq('roleid', 1);
                    if (error) console.error('Error fetching admin sellers:', error);
                    else setAllSellers(data || []);
                };
                fetchAllSellers();
            }, []);

            React.useEffect(() => {
                if (!selectedSellerId) return;
                const fetchSellerProfile = async () => {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('id, fullname, national_id, mobile, location:locationid(postalcode, address, plaque)')
                        .eq('id', selectedSellerId)
                        .single();
                    if (error) {
                        console.error('Error fetching seller profile:', error);
                        setSellerProfile(null);
                    } else {
                        setSellerProfile(data);
                    }
                };
                fetchSellerProfile();
            }, [selectedSellerId]);

            React.useEffect(() => {
                if (!preInvoiceData?.customerId) return;
                const fetchCustomerProfile = async () => {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('id, fullname, national_id, mobile, location:locationid(postalcode, address, plaque)')
                        .eq('id', preInvoiceData.customerId)
                        .single();
                    if (error) {
                        console.error('Error fetching customer profile for pre-invoice:', error);
                        setCustomerProfile({ fullname: preInvoiceData.customerName });
                    } else {
                        setCustomerProfile(data);
                    }
                };
                fetchCustomerProfile();
            }, [preInvoiceData]);


            const handlePrint = () => window.print();

            const formatCurrencyForPrint = (value) => {
                if (value === null || typeof value === 'undefined' || isNaN(value)) return '-';
                const amount = currency === 'Rials' ? value * 10 : value;
                const currencyName = currency === 'Rials' ? 'ریال' : 'تومان';
                return `${Number(amount).toLocaleString('fa-IR')} ${currencyName}`;
            };

            const subtotal = preInvoiceData.items.reduce((sum, item) => sum + item.subtotal, 0);
            
            // Mapping data for the generic layout component
            const layoutProps = {
                title: "پیش فاکتور",
                invoiceNumber: null,
                invoiceDate: new Date().toLocaleDateString('fa-IR'),
                sellerProfile,
                customerProfile,
                items: preInvoiceData.items.map(item => ({
                    id: item.id,
                    itemId: item.id,
                    description: item.product.title,
                    quantity: item.approved_supply_quantity,
                    unitPrice: item.sale_price,
                    total: item.subtotal
                })),
                subtotal,
                discount: preInvoiceData.discount,
                shipping: preInvoiceData.shipping,
                totalAmount: preInvoiceData.totalAmount,
                note: null,
                formatCurrencyForPrint
            };


            return (
                <Modal isOpen={true} onClose={onClose} showHeader={false}>
                    <div className="print-options p-4 bg-gray-100 dark:bg-gray-900 rounded-lg mb-4 flex flex-col md:flex-row gap-4 justify-between items-center">
                        <div className="w-full md:w-1/2">
                            <label htmlFor="seller-select" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">فروشنده:</label>
                            <select id="seller-select" value={selectedSellerId} onChange={(e) => setSelectedSellerId(e.target.value)} className="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-md">
                                {allSellers.map(seller => (<option key={seller.id} value={seller.id}>{seller.fullname}</option>))}
                            </select>
                        </div>
                        <div className="w-full md:w-1/2">
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">واحد پول:</label>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setCurrency('Toman')} className={`w-full px-4 py-2 rounded-md text-sm font-semibold ${currency === 'Toman' ? 'bg-indigo-600 text-white' : 'bg-gray-200 dark:bg-gray-600'}`}>تومان</button>
                                <button onClick={() => setCurrency('Rials')} className={`w-full px-4 py-2 rounded-md text-sm font-semibold ${currency === 'Rials' ? 'bg-indigo-600 text-white' : 'bg-gray-200 dark:bg-gray-600'}`}>ریال</button>
                            </div>
                        </div>
                    </div>
                    
                    <PrintableInvoiceLayout {...layoutProps} />

                    <div className="flex flex-col sm:flex-row justify-end gap-4 mt-4 print-options">
                        <button onClick={onClose} className="w-full sm:w-auto bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-lg">بستن</button>
                        <button onClick={handlePrint} className="w-full sm:w-auto bg-indigo-600 text-white py-2 px-4 rounded-lg">چاپ</button>
                    </div>
                </Modal>
            );
        };

        const PrintableInvoice = ({ invoice, onClose }) => {
            const [sellerProfile, setSellerProfile] = React.useState(null);
            const [allSellers, setAllSellers] = React.useState([]);
            const [selectedSellerId, setSelectedSellerId] = React.useState(APP_CONFIG.DEFAULT_SELLER_ID);
            const [currency, setCurrency] = React.useState(APP_CONFIG.DEFAULT_CURRENCY);
            const [customerProfile, setCustomerProfile] = React.useState(null); // State for fresh customer data

            React.useEffect(() => {
                const fetchAllSellers = async () => {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('id, fullname')
                        .eq('roleid', 1); // Filter for users with the 'admin' role
                    if (error) {
                        console.error('Error fetching admin sellers:', error);
                    } else {
                        setAllSellers(data || []);
                    }
                };
                fetchAllSellers();
            }, []);

            React.useEffect(() => {
                if (!selectedSellerId) return;
                const fetchSellerProfile = async () => {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('id, fullname, national_id, mobile, location:locationid(postalcode, address, plaque)')
                        .eq('id', selectedSellerId)
                        .single();
                    if (error) {
                        console.error('Error fetching seller profile:', error);
                        setSellerProfile(null);
                    } else {
                        setSellerProfile(data);
                    }
                };
                fetchSellerProfile();
            }, [selectedSellerId]);

            React.useEffect(() => {
                if (!invoice?.customer?.id) return;
                const fetchCustomerProfile = async () => {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('id, fullname, national_id, mobile, location:locationid(postalcode, address, plaque)')
                        .eq('id', invoice.customer.id)
                        .single();
                    if (error) {
                        console.error('Error fetching fresh customer profile:', error);
                        setCustomerProfile(invoice.customer); // Fallback to stale data on error
                    } else {
                        setCustomerProfile(data);
                    }
                };
                fetchCustomerProfile();
            }, [invoice]);

            const handlePrint = () => {
                window.print();
            };
            
            const formatCurrencyForPrint = (value) => {
                if (value === null || typeof value === 'undefined' || isNaN(value)) return '-';
                const amount = currency === 'Rials' ? value * 10 : value;
                const currencyName = currency === 'Rials' ? 'ریال' : 'تومان';
                return `${Number(amount).toLocaleString('fa-IR')} ${currencyName}`;
            };

            const subtotal = invoice.demandinvoicedetail.reduce((sum, detail) => sum + (detail.quantity * detail.sales_price), 0);
            
             // Mapping data for the generic layout component
            const layoutProps = {
                title: "فاکتور فروش",
                invoiceNumber: invoice.id,
                invoiceDate: new Date(invoice.createdat).toLocaleDateString('fa-IR'),
                sellerProfile,
                customerProfile,
                items: invoice.demandinvoicedetail.map(detail => ({
                    id: detail.id,
                    itemId: detail.demand_item_id,
                    description: detail.demand_item?.product?.title || 'محصول حذف شده',
                    quantity: detail.quantity,
                    unitPrice: detail.sales_price,
                    total: detail.quantity * detail.sales_price,
                })),
                subtotal,
                discount: invoice.discount,
                shipping: invoice.totalshippingprice,
                totalAmount: invoice.totalamount,
                note: invoice.note,
                formatCurrencyForPrint
            };
            
            return (
                <Modal isOpen={true} onClose={onClose} showHeader={false}>
                    <div className="print-options p-4 bg-gray-100 dark:bg-gray-900 rounded-lg mb-4 flex flex-col md:flex-row gap-4 justify-between items-center">
                        <div className="w-full md:w-1/2">
                            <label htmlFor="seller-select" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">فروشنده:</label>
                            <select
                                id="seller-select"
                                value={selectedSellerId}
                                onChange={(e) => setSelectedSellerId(e.target.value)}
                                className="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-md"
                            >
                                {allSellers.map(seller => (
                                    <option key={seller.id} value={seller.id}>{seller.fullname}</option>
                                ))}
                            </select>
                        </div>
                        <div className="w-full md:w-1/2">
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">واحد پول:</label>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setCurrency('Toman')} className={`w-full px-4 py-2 rounded-md text-sm font-semibold ${currency === 'Toman' ? 'bg-indigo-600 text-white' : 'bg-gray-200 dark:bg-gray-600'}`}>تومان</button>
                                <button onClick={() => setCurrency('Rials')} className={`w-full px-4 py-2 rounded-md text-sm font-semibold ${currency === 'Rials' ? 'bg-indigo-600 text-white' : 'bg-gray-200 dark:bg-gray-600'}`}>ریال</button>
                            </div>
                        </div>
                    </div>

                    <PrintableInvoiceLayout {...layoutProps} />

                   <div className="flex flex-col sm:flex-row justify-end gap-4 mt-4 print-options">
                        <button onClick={onClose} className="w-full sm:w-auto bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-lg">بستن</button>
                        <button onClick={handlePrint} className="w-full sm:w-auto bg-indigo-600 text-white py-2 px-4 rounded-lg">چاپ</button>
                    </div>
                </Modal>
            );
        };

        // ==================================================
        // Invoice Management Component
        // ==================================================
        const InvoiceManagement = () => {
            const [preInvoices, setPreInvoices] = React.useState({});
            const [invoices, setInvoices] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const [isSubmitting, setIsSubmitting] = React.useState(null);
            const [allocationModalState, setAllocationModalState] = React.useState({ isOpen: false, preInvoiceData: null });
            const [activeTab, setActiveTab] = React.useState('pending');
            const [editingInvoice, setEditingInvoice] = React.useState(null);
            const [printingInvoice, setPrintingInvoice] = React.useState(null);
            const [printingPreInvoice, setPrintingPreInvoice] = React.useState(null);
            const { addToast } = useToasts();
            
            // --- Pagination State ---
            const [currentPage, setCurrentPage] = React.useState(0);
            const [invoicesPerPage] = React.useState(10);
            const [totalInvoices, setTotalInvoices] = React.useState(0);

            const fetchPendingData = async () => {
                setIsLoading(true);
                setError('');
                try {
                    const { data: pendingData, error: rpcError } = await supabaseClient.rpc('get_items_for_invoicing');
                    if (rpcError) throw rpcError;
                    
                    const groupedByCustomer = (pendingData || []).reduce((acc, rpcRow) => {
                        const customerId = rpcRow.customer_id;
                        if (!customerId) return acc;
                        if (!acc[customerId]) {
                            acc[customerId] = {
                                customerId: rpcRow.customer_id,
                                customerName: rpcRow.customer_name || 'مشتری نامشخص',
                                demandid: rpcRow.demandid, // Capture the demand ID
                                items: {}, 
                                suppliers: {},
                                totalAmount: 0,
                                shipping: 0,
                                discount: 0
                            };
                        }
                        const itemId = rpcRow.item_id;
                        if (!acc[customerId].items[itemId]) {
                            const sale_price = rpcRow.sale_price || (rpcRow.approved_supply_price ? Math.round(rpcRow.approved_supply_price * 1.10) : 0);
                            const subtotal = (rpcRow.approved_supply_quantity || 0) * sale_price;
                            acc[customerId].items[itemId] = {
                                id: itemId,
                                product: { title: rpcRow.product_name },
                                approved_supply_quantity: rpcRow.approved_supply_quantity,
                                sale_price,
                                subtotal
                            };
                            acc[customerId].totalAmount += subtotal;
                        }
                        const supplierId = rpcRow.supplier_id;
                        if (supplierId && !acc[customerId].suppliers[supplierId]) {
                            acc[customerId].suppliers[supplierId] = { id: supplierId, name: rpcRow.supplier_name };
                        }
                        return acc;
                    }, {});

                    Object.keys(groupedByCustomer).forEach(customerId => {
                        groupedByCustomer[customerId].items = Object.values(groupedByCustomer[customerId].items);
                    });
                    setPreInvoices(groupedByCustomer);
                } catch (err) {
                        console.error("Error fetching pending invoice data:", err);
                        setError(`خطا در بارگذاری اطلاعات آماده صدور: ${err.message}.`);
                        addToast(`خطا در بارگذاری اطلاعات آماده صدور: ${err.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };
            
            const fetchHistoricalData = async () => {
                setIsLoading(true);
                setError('');
                try {
                    const from = currentPage * invoicesPerPage;
                    const to = from + invoicesPerPage - 1;

                    const { data: historicalData, error: historicalError, count } = await supabaseClient
                        .from('demandinvoice')
                        .select(`
                            *, 
                            customer:customeruserid(id, fullname, national_id, mobile, location:locationid(postalcode, address, plaque)), 
                            demandinvoicedetail(*, profiles:supplieruserid(fullname), demand_item:demand_item_id(product(title)), location:locationid(postalcode))
                        `, { count: 'exact' })
                        .order('createdat', { ascending: false })
                        .range(from, to);
                        
                    if (historicalError) throw historicalError;
                    setInvoices(historicalData || []);
                    setTotalInvoices(count || 0);

                } catch (err) {
                    console.error("Error fetching historical invoice data:", err);
                    setError(`خطا در بارگذاری تاریخچه: ${err.message}.`);
                    addToast(`خطا در بارگذاری تاریخچه: ${err.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            }
            
            // On mount, fetch data for the initial tab.
            React.useEffect(() => {
                if (activeTab === 'pending') {
                    fetchPendingData();
                }
            }, []);
            
            // Fetch historical data when the tab is switched to 'history' or when the page changes.
            React.useEffect(() => {
                if(activeTab === 'history') {
                    fetchHistoricalData();
                }
            }, [activeTab, currentPage]);
            
            const refreshData = async () => {
                if (activeTab === 'pending') {
                    await fetchPendingData();
                } else {
                     if(currentPage !== 0) {
                        setCurrentPage(0); // This will trigger the useEffect to refetch the first page
                    } else {
                        await fetchHistoricalData(); // Already on page 0, so manually refetch
                    }
                }
            };
            
            const recalculatePreInvoiceTotal = (invoice) => {
                const subtotal = invoice.items.reduce((sum, item) => sum + item.subtotal, 0);
                const discount = invoice.discount || 0;
                const shipping = invoice.shipping || 0;
                return subtotal - discount + shipping;
            }

            const handlePreInvoiceMetaChange = (customerId, field, value) => {
                setPreInvoices(prev => {
                    const newInvoices = { ...prev };
                    const invoice = { ...newInvoices[customerId] };
                    invoice[field] = parseFormattedNumber(value);
                    invoice.totalAmount = recalculatePreInvoiceTotal(invoice);
                    newInvoices[customerId] = invoice;
                    return newInvoices;
                });
            }

            const handlePriceChange = (customerId, itemId, newPrice) => {
                setPreInvoices(prev => {
                    const newInvoices = { ...prev };
                    const invoice = { ...newInvoices[customerId] };
                    invoice.items = invoice.items.map(item => {
                        if (item.id === itemId) {
                            const price = parseFormattedNumber(newPrice);
                            return { ...item, sale_price: price, subtotal: (item.approved_supply_quantity || 0) * price };
                        }
                        return item;
                    });
                    invoice.totalAmount = recalculatePreInvoiceTotal(invoice);
                    newInvoices[customerId] = invoice;
                    return newInvoices;
                });
            };
            
            const handleQuantityChange = (customerId, itemId, newQuantity) => {
                setPreInvoices(prev => {
                    const newInvoices = { ...prev };
                    const invoice = { ...newInvoices[customerId] };
                    invoice.items = invoice.items.map(item => {
                        if (item.id === itemId) {
                            const quantity = parseFormattedNumber(newQuantity) || 0;
                            return { 
                                ...item, 
                                approved_supply_quantity: quantity, 
                                subtotal: quantity * (item.sale_price || 0) 
                            };
                        }
                        return item;
                    });
                    invoice.totalAmount = recalculatePreInvoiceTotal(invoice);
                    newInvoices[customerId] = invoice;
                    return newInvoices;
                });
            };

            const handleInitiatePayment = (customerId) => {
                setAllocationModalState({ isOpen: true, preInvoiceData: preInvoices[customerId] });
            };

            const handleSaveAllocationAndCreateInvoice = async ({ totalAmountReceived, allocations, preInvoiceData }) => {
                const { customerId, items, discount, shipping, demandid } = preInvoiceData;
                setIsSubmitting(customerId);
                try {
                    // 1. Create Invoice Header
                    const totalQuantity = items.reduce((sum, item) => sum + (item.approved_supply_quantity || 0), 0);
                    const { data: invoiceHeader, error: headerError } = await supabaseClient
                        .from('demandinvoice')
                        .insert({ 
                            demandid: demandid, // <-- Pass the demand ID here
                            customeruserid: customerId, 
                            totalquantity: totalQuantity, 
                            paymentstatusid: 1, // Assuming 1 is 'Paid'
                            totalamount: preInvoiceData.totalAmount,
                            discount: discount || 0,
                            totalshippingprice: shipping || 0
                        })
                        .select()
                        .single();
                    if (headerError) throw headerError;
                    
                    // 2. Create Invoice Details
                    const uniqueItems = Array.from(new Map(items.map(item => [item.id, item])).values());
                    const itemIds = uniqueItems.map(item => item.id);
                    const { data: allAssignments, error: assignmentError } = await supabaseClient
                        .from('supplier_demand_assignment')
                        .select('demand_item_id, supplieruserid')
                        .in('demand_item_id', itemIds);
                    if (assignmentError) throw assignmentError;

                    const invoiceDetails = uniqueItems.map(item => {
                        const assignment = allAssignments.find(a => a.demand_item_id === item.id);
                        return { 
                            demandinvoiceid: invoiceHeader.id, 
                            demand_item_id: item.id, 
                            quantity: item.approved_supply_quantity,
                            sales_price: item.sale_price,
                            supplieruserid: assignment ? assignment.supplieruserid : null
                        };
                    });

                    const { error: detailError } = await supabaseClient.from('demandinvoicedetail').insert(invoiceDetails);
                    if (detailError) throw detailError;

                    // 3. Create Payment Allocations
                    const transactions = [];
                    transactions.push({
                        userid: customerId,
                        amount: totalAmountReceived,
                        demandinvoiceid: invoiceHeader.id,
                        transactiontypeid: 1 // 'Customer Payment'
                    });
                    allocations.forEach(alloc => {
                        transactions.push({
                            userid: alloc.userId,
                            amount: -Math.abs(alloc.amount),
                            demandinvoiceid: invoiceHeader.id,
                            transactiontypeid: 2 // 'Supplier Payout'
                        });
                    });
                    
                        for (const transaction of transactions) {
                            const { error: transactionError } = await supabaseClient.from('usertransaction').insert(transaction);
                            if (transactionError) {
                                throw new Error(`Failed to save transaction for user ${transaction.userid}: ${transactionError.message}`);
                            }
                        }

                    // 4. Update Item Quantities and Status
                    const PAID_AWAITING_SHIPMENT_STATUS_ID = 19;
                    const itemUpdates = uniqueItems.map(item => 
                        supabaseClient
                            .from('demand_item')
                            .update({ 
                                approved_supply_quantity: item.approved_supply_quantity,
                                demandstatusid: PAID_AWAITING_SHIPMENT_STATUS_ID
                            })
                            .eq('id', item.id)
                    );
                    
                    const updateResults = await Promise.all(itemUpdates);
                    const firstUpdateError = updateResults.find(res => res.error);
                    if (firstUpdateError) throw firstUpdateError.error;
                    
                    addToast('فاکتور و تخصیص پرداخت با موفقیت ثبت شد!', 'success');
                    setAllocationModalState({ isOpen: false, preInvoiceData: null });
                    await fetchPendingData(); // Refresh pending list
                    if (activeTab === 'history') await fetchHistoricalData(); // Refresh history if viewing it
                } catch (err) {
                    console.error("Error creating invoice and allocations:", err);
                    addToast(`خطا در ایجاد فاکتور: ${err.message}`, 'error');
                    throw err;
                } finally {
                    setIsSubmitting(null);
                }
            };
            
            const handleOpenEditModal = (invoice) => {
                const enrichedDetails = invoice.demandinvoicedetail.map(detail => ({
                    ...detail,
                    product: { title: detail.demand_item?.product?.title || 'محصول حذف شده' }
                }));
                setEditingInvoice({ ...invoice, demandinvoicedetail: enrichedDetails });
            };

            const handleCloseEditModal = () => setEditingInvoice(null);
            
            const handleOpenPrintModal = (invoice) => setPrintingInvoice(invoice);
            const handleClosePrintModal = () => setPrintingInvoice(null);
            const handleOpenPrintPreInvoiceModal = (data) => setPrintingPreInvoice(data);
            const handleClosePrintPreInvoiceModal = () => setPrintingPreInvoice(null);

            const handleSaveInvoice = () => {
                fetchHistoricalData(); // Refresh historical data after edit
                handleCloseEditModal();
            };

            const handleTabChange = (tab) => {
                setActiveTab(tab);
                setCurrentPage(0); // Reset page when switching tabs
                if (tab === 'pending' && Object.keys(preInvoices).length === 0) {
                    fetchPendingData();
                }
            };
            
            const nextPage = () => {
                if ((currentPage + 1) * invoicesPerPage < totalInvoices) {
                    setCurrentPage(currentPage + 1);
                }
            };
        
            const prevPage = () => {
                if (currentPage > 0) {
                    setCurrentPage(currentPage - 1);
                }
            };

            return (
                <div className="p-4 md:p-6 lg:p-8 text-gray-900 dark:text-gray-100">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl md:text-3xl font-bold">مدیریت فاکتورها</h1>
                        <button 
                            onClick={refreshData} 
                            disabled={isLoading}
                            className="bg-indigo-500 text-white py-2 px-4 rounded-lg font-semibold text-sm hover:bg-indigo-600 transition-colors disabled:bg-indigo-400 disabled:cursor-wait"
                        >
                            {isLoading ? '...' : 'بارگذاری مجدد'}
                        </button>
                    </div>

                    <div className="border-b border-gray-200 dark:border-gray-700 mb-6">
                        <nav className="-mb-px flex space-x-4 space-x-reverse">
                            <button onClick={() => handleTabChange('pending')} className={`px-4 py-2 text-sm font-semibold border-b-2 ${activeTab === 'pending' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 dark:text-gray-400'}`}>آماده صدور</button>
                            <button onClick={() => handleTabChange('history')} className={`px-4 py-2 text-sm font-semibold border-b-2 ${activeTab === 'history' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 dark:text-gray-400'}`}>تاریخچه فاکتورها</button>
                        </nav>
                    </div>
                    
                    {isLoading && <div className="spinner"></div>}
                    {error && <p className="text-center p-8 text-red-500 bg-red-100 dark:bg-red-900/50 rounded-lg">{error}</p>}
                    
                    {!isLoading && !error && activeTab === 'pending' && (
                        <div className="space-y-8">
                            {Object.keys(preInvoices).length > 0 ? Object.entries(preInvoices).map(([customerId, invoiceData]) => (
                                <div key={customerId} className="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow-md border-t-4 border-indigo-500">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                                        <div><h2 className="text-lg md:text-xl font-bold">پیش‌فاکتور برای: <span className="font-mono">{invoiceData.customerName}</span></h2></div>
                                        <div className="mt-4 sm:mt-0 text-left w-full sm:w-auto"><p className="text-sm text-gray-600 dark:text-gray-400">مبلغ کل:</p><p className="text-xl md:text-2xl font-bold text-indigo-600 dark:text-indigo-400">{formatCurrency(invoiceData.totalAmount)} تومان</p></div>
                                    </div>
                                    
                                    {/* Desktop Table for Items */}
                                    <div className="hidden md:block overflow-x-auto">
                                        <table className="w-full text-right min-w-[600px]">
                                            <thead><tr className="border-b dark:border-gray-700"><th className="p-2 font-semibold">محصول</th><th className="p-2 font-semibold">تعداد</th><th className="p-2 font-semibold">قیمت فروش</th><th className="p-2 font-semibold">مبلغ کل</th></tr></thead>
                                            <tbody>
                                                {invoiceData.items.map(item => (
                                                    <tr key={item.id} className="border-b dark:border-gray-700 last:border-b-0">
                                                        <td className="p-2">{item.product.title}</td>
                                                        <td className="p-2">
                                                            <input 
                                                                type="number" 
                                                                value={item.approved_supply_quantity} 
                                                                onChange={e => handleQuantityChange(customerId, item.id, e.target.value)} 
                                                                className="w-20 bg-gray-100 dark:bg-gray-700 p-1 rounded-md text-center" 
                                                            />
                                                        </td>
                                                        <td className="p-2"><input type="text" value={formatNumberWithCommas(item.sale_price)} onChange={e => handlePriceChange(customerId, item.id, e.target.value)} className="w-32 bg-gray-100 dark:bg-gray-700 p-1 rounded-md text-center" /></td>
                                                        <td className="p-2">{formatCurrency(item.subtotal)} تومان</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Mobile Card View for Items */}
                                    <div className="md:hidden space-y-3">
                                        {invoiceData.items.map(item => (
                                            <div key={item.id} className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                                <p className="font-bold mb-2">{item.product.title}</p>
                                                <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-400">تعداد</label>
                                                        <input 
                                                            type="number" 
                                                            value={item.approved_supply_quantity} 
                                                            onChange={e => handleQuantityChange(customerId, item.id, e.target.value)} 
                                                            className="w-full bg-white dark:bg-gray-600 p-1 rounded-md text-center mt-1" 
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-500 dark:text-gray-400">قیمت فروش</label>
                                                        <input 
                                                            type="text" 
                                                            value={formatNumberWithCommas(item.sale_price)} 
                                                            onChange={e => handlePriceChange(customerId, item.id, e.target.value)} 
                                                            className="w-full bg-white dark:bg-gray-600 p-1 rounded-md text-center mt-1" 
                                                        />
                                                    </div>
                                                    <div className="col-span-2 mt-2 pt-2 border-t dark:border-gray-600">
                                                        <span className="text-xs text-gray-500 dark:text-gray-400">مبلغ کل</span>
                                                        <p className="font-semibold">{formatCurrency(item.subtotal)} تومان</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تخفیف (تومان)</label>
                                            <input
                                                type="text"
                                                placeholder="0"
                                                value={formatNumberWithCommas(invoiceData.discount)}
                                                onChange={e => handlePreInvoiceMetaChange(customerId, 'discount', e.target.value)}
                                                className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-md text-center"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">هزینه ارسال (تومان)</label>
                                            <input
                                                type="text"
                                                placeholder="0"
                                                value={formatNumberWithCommas(invoiceData.shipping)}
                                                onChange={e => handlePreInvoiceMetaChange(customerId, 'shipping', e.target.value)}
                                                className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-md text-center"
                                            />
                                        </div>
                                    </div>

                                    <div className="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-end gap-3">
                                        <button onClick={() => handleOpenPrintPreInvoiceModal(invoiceData)} className="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg">چاپ پیش‌فاکتور</button>
                                        <button onClick={() => handleInitiatePayment(customerId)} disabled={isSubmitting === customerId} className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg disabled:bg-green-400">ثبت و تخصیص پرداخت</button>
                                    </div>
                                </div>
                            )) : <p className="text-center p-12 bg-white dark:bg-gray-800 rounded-lg shadow">هیچ فاکتوری برای صدور وجود ندارد.</p>}
                        </div>
                    )}

                    {!isLoading && !error && activeTab === 'history' && (
                        <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            {/* Desktop Table */}
                            <div className="hidden md:block overflow-x-auto">
                                <table className="w-full text-right min-w-[600px]">
                                    <thead><tr className="border-b dark:border-gray-700"><th className="p-3 font-semibold">شماره فاکتور</th><th className="p-3 font-semibold">مشتری</th><th className="p-3 font-semibold">تاریخ</th><th className="p-3 font-semibold">مبلغ کل</th><th className="p-3 font-semibold">عملیات</th></tr></thead>
                                    <tbody>
                                        {invoices.map(invoice => (
                                            <tr key={invoice.id} className="border-b dark:border-gray-700 last:border-b-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                                <td className="p-3 font-mono">{invoice.id}</td>
                                                <td className="p-3">{invoice.customer?.fullname || 'نامشخص'}</td>
                                                <td className="p-3">{new Date(invoice.createdat).toLocaleDateString('fa-IR')}</td>
                                                <td className="p-3 font-semibold">{formatCurrency(invoice.totalamount)} تومان</td>
                                                <td className="p-3 space-x-4 space-x-reverse">
                                                    <button onClick={() => handleOpenEditModal(invoice)} className="text-indigo-500 hover:text-indigo-700 font-semibold">ویرایش</button>
                                                    <button onClick={() => handleOpenPrintModal(invoice)} className="text-green-500 hover:text-green-700 font-semibold">چاپ</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                             {/* Mobile Card View */}
                            <div className="md:hidden space-y-4">
                                {invoices.map(invoice => (
                                    <div key={invoice.id} className="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg shadow">
                                        <div className="flex justify-between items-center mb-2 pb-2 border-b dark:border-gray-600">
                                            <div>
                                                <span className="text-sm text-gray-500 dark:text-gray-400">شماره فاکتور</span>
                                                <p className="font-bold font-mono text-indigo-600 dark:text-indigo-400">{invoice.id}</p>
                                            </div>
                                            <div className="text-left">
                                                <span className="text-sm text-gray-500 dark:text-gray-400">تاریخ</span>
                                                <p className="font-semibold">{new Date(invoice.createdat).toLocaleDateString('fa-IR')}</p>
                                            </div>
                                        </div>
                                        <div className="mb-3">
                                            <span className="text-sm text-gray-500 dark:text-gray-400">مشتری</span>
                                            <p className="font-semibold">{invoice.customer?.fullname || 'نامشخص'}</p>
                                        </div>
                                        <div className="mb-4">
                                            <span className="text-sm text-gray-500 dark:text-gray-400">مبلغ کل</span>
                                            <p className="font-bold text-lg">{formatCurrency(invoice.totalamount)} تومان</p>
                                        </div>
                                        <div className="flex justify-end gap-4 border-t dark:border-gray-600 pt-3">
                                            <button onClick={() => handleOpenEditModal(invoice)} className="text-indigo-500 hover:text-indigo-700 font-semibold text-sm">ویرایش</button>
                                            <button onClick={() => handleOpenPrintModal(invoice)} className="text-green-500 hover:text-green-700 font-semibold text-sm">چاپ</button>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* --- Pagination Controls --- */}
                            <div className="flex justify-between items-center mt-4 p-2">
                                <button 
                                    onClick={prevPage} 
                                    disabled={currentPage === 0 || isLoading}
                                    className="bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    قبلی
                                </button>
                                <span className="text-sm text-gray-700 dark:text-gray-300">
                                    صفحه {currentPage + 1} از {Math.ceil(totalInvoices / invoicesPerPage) || 1}
                                </span>
                                <button 
                                    onClick={nextPage} 
                                    disabled={(currentPage + 1) * invoicesPerPage >= totalInvoices || isLoading}
                                    className="bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    بعدی
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {allocationModalState.isOpen && (
                        <PaymentAllocationModal 
                            isOpen={allocationModalState.isOpen} 
                            onClose={() => setAllocationModalState({ isOpen: false, preInvoiceData: null })} 
                            onSave={handleSaveAllocationAndCreateInvoice}
                            preInvoiceData={allocationModalState.preInvoiceData}
                        />
                    )}
                    {editingInvoice && <EditInvoiceModal isOpen={!!editingInvoice} onClose={handleCloseEditModal} onSave={handleSaveInvoice} invoice={editingInvoice} addToast={addToast} />}
                    {printingInvoice && <PrintableInvoice invoice={printingInvoice} onClose={handleClosePrintModal} />}
                    {printingPreInvoice && <PrintablePreInvoice preInvoiceData={printingPreInvoice} onClose={handleClosePrintPreInvoiceModal} />}
                </div>
            );
        };
        
        // App component to provide Toast context
        const App = () => (
            <ToastProvider>
                <InvoiceManagement />
            </ToastProvider>
        );

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>

